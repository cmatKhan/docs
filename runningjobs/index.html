<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>Running Jobs - High Throughput Computing Facility @ CGSSB</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="generator" content="mkdocs-1.3.0, mkdocs-gitbook-1.0.7">

<link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta rel="next" href="" />
<link href="../css/style.min.css" rel="stylesheet">
<link href="../stylesheets/extra.css" rel="stylesheet"> 
</head>

<body>
<div class="book">
<div class="book-summary">
<div id="book-search-input" role="search">
<input type="text" placeholder="Type to search" />
</div> <!-- end of book-search-input -->

<nav role="navigation">
<ul class="summary">
<li>
<a href=".." target="_blank" class="custom-link">High Throughput Computing Facility @ CGSSB</a>
</li>
<li class="divider"></li>
<li class="chapter" data-path="">
<a href="..">The HTCF</a>
<li class="header">Doing Work</li>

<li>
<a href="../getstarted/" class="">Getting Started</a>
</li>

<li>
<a href="./" class="active">Running Jobs</a>
</li>

<li>
<a href="../using/queue/" class="">The Queue</a>
</li>

<li>
<a href="../using/" class="">Using the HTCF</a>
</li>

<li>
<a href="../using/batch/" class="">Batch Jobs</a>
</li>

<li>
<a href="../using/interactive/" class="">Interactive Jobs</a>
</li>

<li>
<a href="../using/accounting/" class="">Job Accounting</a>
</li>

<li class="chapter" data-path="policies/">
<a href="../policies/">Policies</a>
<li class="header">Storage</li>

<li>
<a href="../storage/" class="">Overview</a>
</li>

<li>
<a href="../storage/hts/" class="">HTS</a>
</li>

<li>
<a href="../storage/ref/" class="">REF</a>
</li>

<li>
<a href="../storage/lts/" class="">LTS</a>
</li>

<li>
<a href="../storage/ltos/" class="">LTOS</a>
</li>

<li>
<a href="../storage/new_index.md" class="">Beta</a>
</li>

<li class="chapter" data-path="software/">
<a href="../software/">Software</a>
<li class="divider"></li>



<li><a href="http://www.mkdocs.org">
Published with MkDocs
</a></li>

<li><a href="https://github.com/GitbookIO/theme-default">
Theme by GitBook
</a></li>
</ul>

</nav>

</div> <!-- end of book-summary -->

<div class="book-body">
<div class="body-inner">
<div class="book-header" role="navigation">

<!-- Title -->
<h1>
<i class="fa fa-circle-o-notch fa-spin"></i>
<a href="." ></a>
</h1>

</div> <!-- end of book-header -->

<div class="page-wrapper" tabindex="-1" role="main">
<div class="page-inner">
<div id="book-search-results">
<div class="search-noresults">

<section class="normal markdown-section">



<p>Many times you might have a command that you’d like to run on a lot of samples.  To run these sequentially, you might have a script like this:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

module load spades

spades.py --careful --pe1-1 samp1-r1.fastq --pe1-2 samp1-r2.fastq -o assembly_1
spades.py --careful --pe1-1 samp2-r1.fastq --pe1-2 samp2-r2.fastq -o assembly_2
…
spades.py --careful --pe1-1 samp2000-r1.fastq --pe1-2 samp2000-r2.fastq -o assembly_2000
</code></pre></div>
<p>By submitting this on the HTCF as an “array job”, you have the potential of running each of these commands in parallel (all at the same time) rather than sequentially (one at a time).  The best case scenario could be that all 2000 commands finish in the time it takes 1 command to run!  More information regarding SLURM job arrays is available at <a href="http://slurm.schedmd.com/job_array.html">http://slurm.schedmd.com/job_array.html</a>.</p>
<hr />
<h5 id="run-a-command-or-set-of-commands-on-file-names-that-are-sequentially-numbered">Run a command or set of commands on file names that are sequentially numbered</h5>
<table>
<thead>
<tr>
<th>Input File 1</th>
<th></th>
<th>Input File 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>sample1-r1.fastq</td>
<td></td>
<td>sample1-r2.fastq</td>
</tr>
<tr>
<td>sample2-r1.fastq</td>
<td></td>
<td>sample2-r2.fastq</td>
</tr>
<tr>
<td>…</td>
<td></td>
<td>…</td>
</tr>
<tr>
<td>sample2000-r1.fastq</td>
<td></td>
<td>sample2000-r2.fastq</td>
</tr>
</tbody>
</table>
<p>Step 1:  Create an sbatch file</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --array=1-2000%20   # This will create 2000 tasks numbered 1-2000 and allow 20 concurrent jobs to run</span>

module load spades

<span class="nv">ID</span><span class="o">=</span><span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span>  <span class="c1"># Number between 1 and 2000 </span>

spades.py --careful --pe1-1 samp<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>-r1.fastq --pe1-2 samp<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>-r2.fastq -o assembly_<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>
</code></pre></div>
<h5 id="run-a-command-or-set-of-commands-on-file-names-that-arent-numbered-sequentially">Run a command or set of commands on file names that aren’t numbered sequentially</h5>
<hr />
<table>
<thead>
<tr>
<th>Input File 1</th>
<th></th>
<th>Input File 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>sampleAAA-r1.fastq</td>
<td></td>
<td>sampleAAA-r2.fastq</td>
</tr>
<tr>
<td>sampleAAB-r1.fastq</td>
<td></td>
<td>sampleAAB-r2.fastq</td>
</tr>
<tr>
<td>…</td>
<td></td>
<td>…</td>
</tr>
<tr>
<td>SampleZZZ-r1.fastq</td>
<td></td>
<td>SampleZZZ-r2.fastq</td>
</tr>
</tbody>
</table>
<p>Step 1:  Create a “lookup” file, lookup.txt
<div class="highlight"><pre><span></span><code>AAA
AAB
…
ZZZ
</code></pre></div></p>
<p>Step 2: Find the number of lines in lookup file.  This will be the number of tasks in your array job.</p>
<p><div class="highlight"><pre><span></span><code>$ wc -l lookup.txt
2000 lookup.txt
</code></pre></div>
Step 2: Create an sbatch file, grabbing the “ID” in line $SLURM_ARRAY_TASK_ID from the lookup file
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --array=1-2000%20   # This will create 2000 tasks numbered 1-2000 and allow 20 concurrent jobs to run</span>

module load spades

<span class="nv">ID</span><span class="o">=</span><span class="k">$(</span> sed -n <span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span>p lookup.txt <span class="k">)</span>

spades.py --careful --pe1-1 samp<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>-r1.fastq --pe1-2 samp<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>-r2.fastq -o assembly_<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>
</code></pre></div></p>
<h5 id="run-a-command-or-set-of-commands-using-a-complex-lookup-file">Run a command or set of commands using a complex lookup file</h5>
<hr />
<p>Step 1:  Create a “lookup” file, lookup.txt
<div class="highlight"><pre><span></span><code>5 sampleAAA_R1 0.0001 5000 
5 sampleAAA_R2 0.0001 5000
5 sampleBBB_R1 0.0005 1000 
5 sampleBBB_R2 0.0005 1000 
</code></pre></div></p>
<p>Step 2:  Find the number of lines in lookup file.  This will be the number of tasks in your array job.</p>
<p><div class="highlight"><pre><span></span><code>$ wc -l lookup.txt
2000 lookup.txt
</code></pre></div>
Step 3: Create an sbatch file, each job is created using the template with information from the lookup file.
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --array=1-2000%20   # This will create 2000 tasks numbered 1-2000 and allow 20 concurrent jobs to run</span>

module load seqtk

<span class="nb">read</span> part1 part2 part3 part4 &lt; &lt;<span class="o">(</span> sed -n <span class="si">${</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="si">}</span>p lookup.txt <span class="o">)</span>

seqtk sample -s<span class="si">${</span><span class="nv">part1</span><span class="si">}</span> /path/to/file.<span class="si">${</span><span class="nv">part2</span><span class="si">}</span>.fastq <span class="si">${</span><span class="nv">part3</span><span class="si">}</span> &gt; /path/to/file.<span class="si">${</span><span class="nv">part2</span><span class="si">}</span>_<span class="si">${</span><span class="nv">part4</span><span class="si">}</span>.fastq
</code></pre></div></p>


</section>
</div> <!-- end of search-noresults -->
<div class="search-results">
<div class="has-results">

<h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
<ul class="search-results-list"></ul>

</div> <!-- end of has-results -->
<div class="no-results">

<h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>

</div> <!-- end of no-results -->
</div> <!-- end of search-results -->
</div> <!-- end of book-search-results -->

</div> <!-- end of page-inner -->
</div> <!-- end of page-wrapper -->

</div> <!-- end of body-inner -->

</div> <!-- end of book-body -->
<script src="../js/main.js"></script>
<script src="../search/main.js"></script>
<script src="../js/gitbook.min.js"></script>
<script src="../js/theme.min.js"></script>
</body>
</html>